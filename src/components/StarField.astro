---
/* Fondo de estrellas flotantes + estrellas al hacer click */
---

<canvas id="star-field" class="star-canvas"></canvas>

<style>
	.star-canvas {
		position: fixed;
		inset: 0;
		z-index: 1;
		pointer-events: none;
		opacity: 0;
		transition: opacity 1.5s ease;
	}
</style>

<script>
	const canvas = document.getElementById('star-field') as HTMLCanvasElement;
	const ctx = canvas.getContext('2d')!;

	let W = 0;
	let H = 0;
	let stars: Star[] = [];
	let clickStars: ClickStar[] = [];
	let comets: Comet[] = [];
	let active = false;
	let lastCometTime = 0;

	interface Star {
		x: number; y: number; r: number;
		baseAlpha: number; alpha: number;
		speed: number; phase: number;
		drift: number;
	}

	interface ClickStar {
		x: number; y: number; r: number;
		vx: number; vy: number;
		alpha: number; decay: number;
		rotation: number; rotSpeed: number;
	}

	interface CometTrail {
		x: number; y: number; alpha: number;
	}

	interface Comet {
		x: number; y: number;
		vx: number; vy: number;
		size: number;
		alpha: number;
		life: number;
		maxLife: number;
		trail: CometTrail[];
		color: string;
	}

	function resize() {
		W = window.innerWidth;
		H = window.innerHeight;
		canvas.width = W * devicePixelRatio;
		canvas.height = H * devicePixelRatio;
		canvas.style.width = W + 'px';
		canvas.style.height = H + 'px';
		ctx.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);
	}

	function createStars() {
		const count = Math.floor((W * H) / 12000);
		stars = [];
		for (let i = 0; i < count; i++) {
			stars.push({
				x: Math.random() * W,
				y: Math.random() * H,
				r: Math.random() * 1.8 + 0.3,
				baseAlpha: Math.random() * 0.5 + 0.1,
				alpha: 0,
				speed: Math.random() * 0.15 + 0.02,
				phase: Math.random() * Math.PI * 2,
				drift: (Math.random() - 0.5) * 0.12,
			});
		}
	}

	function drawStar(x: number, y: number, r: number, alpha: number, rotation = 0) {
		ctx.save();
		ctx.translate(x, y);
		ctx.rotate(rotation);
		ctx.globalAlpha = alpha;

		// Glow
		ctx.shadowColor = 'rgba(220, 230, 245, 0.6)';
		ctx.shadowBlur = r * 4;

		// Star shape
		ctx.beginPath();
		for (let i = 0; i < 5; i++) {
			const angle = (i * 4 * Math.PI) / 5 - Math.PI / 2;
			const method = i === 0 ? 'moveTo' : 'lineTo';
			ctx[method](Math.cos(angle) * r, Math.sin(angle) * r);
		}
		ctx.closePath();
		ctx.fillStyle = `rgba(220, 225, 240, ${alpha})`;
		ctx.fill();

		// Center dot for extra brightness
		ctx.shadowBlur = 0;
		ctx.beginPath();
		ctx.arc(0, 0, r * 0.3, 0, Math.PI * 2);
		ctx.fillStyle = `rgba(255, 255, 255, ${alpha * 0.8})`;
		ctx.fill();

		ctx.restore();
	}

	function spawnClickStars(x: number, y: number) {
		const count = 8 + Math.floor(Math.random() * 6);
		for (let i = 0; i < count; i++) {
			const angle = (Math.PI * 2 * i) / count + (Math.random() - 0.5) * 0.5;
			const speed = Math.random() * 3 + 1.5;
			clickStars.push({
				x, y,
				r: Math.random() * 3 + 1.5,
				vx: Math.cos(angle) * speed,
				vy: Math.sin(angle) * speed - 1,
				alpha: 1,
				decay: Math.random() * 0.015 + 0.01,
				rotation: Math.random() * Math.PI * 2,
				rotSpeed: (Math.random() - 0.5) * 0.1,
			});
		}
	}

	// ── Comets ──────────────────────────────────────
	const cometColors = [
		'200, 210, 230',   // cool white-blue
		'230, 220, 200',   // warm white
		'180, 200, 240',   // soft blue
		'220, 200, 240',   // soft purple
	];

	function spawnComet() {
		const side = Math.random();
		let x: number, y: number, vx: number, vy: number;

		if (side < 0.5) {
			// From top-right going down-left
			x = W * (0.3 + Math.random() * 0.7);
			y = -10;
			const angle = Math.PI * (0.55 + Math.random() * 0.3);
			const speed = 3 + Math.random() * 4;
			vx = Math.cos(angle) * speed;
			vy = -Math.sin(angle) * speed;
		} else {
			// From top-left going down-right
			x = W * Math.random() * 0.5;
			y = -10;
			const angle = Math.PI * (0.05 + Math.random() * 0.35);
			const speed = 3 + Math.random() * 4;
			vx = Math.cos(angle) * speed;
			vy = Math.sin(angle) * speed;
		}

		const maxLife = 80 + Math.random() * 100;

		comets.push({
			x, y, vx, vy,
			size: 1.5 + Math.random() * 2,
			alpha: 0.8 + Math.random() * 0.2,
			life: 0,
			maxLife,
			trail: [],
			color: cometColors[Math.floor(Math.random() * cometColors.length)],
		});
	}

	function drawComet(c: Comet) {
		const progress = c.life / c.maxLife;
		const fadeIn = Math.min(progress * 5, 1);
		const fadeOut = Math.max(1 - (progress - 0.7) / 0.3, 0);
		const currentAlpha = c.alpha * fadeIn * (progress > 0.7 ? fadeOut : 1);

		// Draw trail
		for (let i = 0; i < c.trail.length; i++) {
			const t = c.trail[i];
			const trailProgress = i / c.trail.length;
			const trailAlpha = t.alpha * trailProgress * 0.4;
			const trailSize = c.size * trailProgress * 0.6;

			ctx.beginPath();
			ctx.arc(t.x, t.y, trailSize, 0, Math.PI * 2);
			ctx.fillStyle = `rgba(${c.color}, ${trailAlpha})`;
			ctx.fill();
		}

		// Draw head with glow
		ctx.save();
		ctx.shadowColor = `rgba(${c.color}, 0.8)`;
		ctx.shadowBlur = c.size * 8;
		ctx.beginPath();
		ctx.arc(c.x, c.y, c.size, 0, Math.PI * 2);
		ctx.fillStyle = `rgba(${c.color}, ${currentAlpha})`;
		ctx.fill();

		// Bright core
		ctx.shadowBlur = 0;
		ctx.beginPath();
		ctx.arc(c.x, c.y, c.size * 0.4, 0, Math.PI * 2);
		ctx.fillStyle = `rgba(255, 255, 255, ${currentAlpha * 0.9})`;
		ctx.fill();
		ctx.restore();
	}

	let t = 0;
	function animate() {
		if (!active) return;
		requestAnimationFrame(animate);
		t += 0.016;

		ctx.clearRect(0, 0, W, H);

		// Background stars
		for (const s of stars) {
			s.phase += s.speed * 0.05;
			s.alpha = s.baseAlpha + Math.sin(s.phase) * s.baseAlpha * 0.7;
			s.x += s.drift * 0.3;
			s.y -= s.speed * 0.3;

			// Wrap
			if (s.y < -5) { s.y = H + 5; s.x = Math.random() * W; }
			if (s.x < -5) s.x = W + 5;
			if (s.x > W + 5) s.x = -5;

			drawStar(s.x, s.y, s.r, s.alpha);
		}

		// Click burst stars
		for (let i = clickStars.length - 1; i >= 0; i--) {
			const cs = clickStars[i];
			cs.x += cs.vx;
			cs.y += cs.vy;
			cs.vy += 0.04; // gentle gravity
			cs.alpha -= cs.decay;
			cs.rotation += cs.rotSpeed;

			if (cs.alpha <= 0) {
				clickStars.splice(i, 1);
				continue;
			}

			drawStar(cs.x, cs.y, cs.r, cs.alpha, cs.rotation);
		}

		// Comets
		const now = performance.now();
		if (now - lastCometTime > 3000 + Math.random() * 5000 && comets.length < 3) {
			spawnComet();
			lastCometTime = now;
		}

		for (let i = comets.length - 1; i >= 0; i--) {
			const c = comets[i];
			// Save trail point
			c.trail.push({ x: c.x, y: c.y, alpha: c.alpha });
			if (c.trail.length > 25) c.trail.shift();

			c.x += c.vx;
			c.y += c.vy;
			c.life++;

			if (c.life >= c.maxLife || c.x < -50 || c.x > W + 50 || c.y > H + 50) {
				comets.splice(i, 1);
				continue;
			}

			drawComet(c);
		}
	}

	function start() {
		active = true;
		resize();
		createStars();
		canvas.style.opacity = '1';
		animate();
	}

	// Pointer events on document (canvas is pointer-events: none)
	document.addEventListener('pointerdown', (e) => {
		if (!active) return;
		spawnClickStars(e.clientX, e.clientY);
	});

	window.addEventListener('resize', () => {
		if (!active) return;
		resize();
		createStars();
	});

	document.addEventListener('welcome:done', () => {
		start();
	});
</script>
